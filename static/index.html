<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
* {
  box-sizing: border-box;
}

.row::after {
  content: "";
  clear: both;
  display: table;
}

[class*="col-"] {
  padding: 1px;
  float: left;
}

.top_menu {
    width: 100%;
}

.button {
  padding: 5px;
  margin-bottom: 5px;
  color: black;
  background-color: white;
  border: 1px solid black;
}

.button:hover {
    background-color: black;
    color: #ffffff;
}

[class*="col-"] {
  width: 100%;
}

@media only screen and (min-width: 700px) {
  .col-s-1 {width: 8.33%;}
  .col-s-2 {width: 16.66%;}
  .col-s-3 {width: 25%;}
  .col-s-4 {width: 33.33%;}
  .col-s-5 {width: 41.66%;}
  .col-s-6 {width: 50%;}
  .col-s-7 {width: 58.33%;}
  .col-s-8 {width: 66.66%;}
  .col-s-9 {width: 75%;}
  .col-s-10 {width: 83.33%;}
  .col-s-11 {width: 91.66%;}
  .col-s-12 {width: 100%;}
}
@media only screen and (min-width: 1000px) {
  .col-1 {width: 8.33%;}
  .col-2 {width: 16.66%;}
  .col-3 {width: 25%;}
  .col-4 {width: 33.33%;}
  .col-5 {width: 41.66%;}
  .col-6 {width: 50%;}
  .col-7 {width: 58.33%;}
  .col-8 {width: 66.66%;}
  .col-9 {width: 75%;}
  .col-10 {width: 83.33%;}
  .col-11 {width: 91.66%;}
  .col-12 {width: 100%;}
}
</style>
</head>
<body>

<div class="row">
  <h1 tabindex="0" id="menu_heading">Menu</h3>
  <div id="menu" class="menu">
    loading...
  </div>

  <div id="main" class="col-7 col-s-7"></div>

  <div id="extra_attributes" class="col-7 col-s-7">
  </div>
</div>

</body>

<script>
    var url = 'https://' + location.hostname + ':5001/api';
    var removeAllChildElements = function(element) {
        if(element == null) {
            return;
        }

        while (element.firstChild) {
            element.removeChild(element.lastChild);
        }

        return;
    }

    var send_http_request = function(params, callback_function) {
        var http = new XMLHttpRequest();
        http.onreadystatechange = function() { 
            if (http.readyState == 4) {
                var result = {};
                try {
                    result = JSON.parse(http.responseText);
                    result[Object.keys(result)[0]]["[http_status]"] = http.status;
                    callback_function(result);
                    if(result[Object.keys(result)[0]]["[errors]"].length > 0) {
                        console.error(JSON.stringify(result));
                    } else {
                        console.log(JSON.stringify(result));
                    }
                } catch(ex) {
                    result["unknown"] = {};
                    result["unknown"]["[errors]"] = [ex.toString()];
                    result["unknown"]["[http_status]"] = http.status;
                    callback_function(result);
                    console.error(JSON.stringify(result));
                }
            }
        }
        http.open('POST', url, true);
        http.setRequestHeader('Content-Type', 'application/json');
        http.send(JSON.stringify(params));
    }

    var load_records = function(table_name) {
        table_name = table_name.replace(/\\\"/g, "\"");
        
        /*main_content = document.getElementById("main");
        removeAllChildElements(main_content);

        const title = document.createElement("h2");
        title.setAttribute("tabindex", "0");
        title.setAttribute("id", "content_heading");
        const title_text = document.createTextNode(encodeURIComponent(table_name) + " records");
        title.appendChild(title_text);
        main_content.appendChild(title);
        document.getElementById("content_heading").focus();*/

        var temp_message_type = "GetSchema_" + decodeURIComponent(table_name);
        var params = {};
        params[temp_message_type] = {};

        var callback_function = function(result) {
            var message_type = Object.keys(result)[0]
            if(result[message_type]["[errors]"].length > 0) {
                return;
            }

            console.log(result);
        }
        send_http_request(params, callback_function);
    }
    

    var navigate_to_view_table = function(table_name) {
        table_name = table_name.replace(/\\\"/g, "\"");
        main_content = document.getElementById("main");
        removeAllChildElements(main_content);

        const title = document.createElement("h2");
        title.setAttribute("tabindex", "0");
        title.setAttribute("id", "content_heading");
        const title_text = document.createTextNode(encodeURIComponent(table_name) + " records");
        title.appendChild(title_text);
        main_content.appendChild(title);
        document.getElementById("content_heading").focus();

        var temp_message_type = "ReadRecords_" + decodeURIComponent(table_name);
        var params = {};
        params[temp_message_type] = {"[select_fields]":["[minimal_fields]"]};

        var callback_function = function(result) {
            var message_type = Object.keys(result)[0]
            if(result[message_type]["[errors]"].length > 0) {
                return;
            }

            var payload = result[message_type];
            var records = payload["data"];
            const table = document.createElement("table");
            for(var i = 0; i < records.length; i++) {
                var current_record = records[i];
                var column_names = Object.keys(current_record);
                {
                    if(i == 0) {
                        const rowHeader = document.createElement("tr");
                        for(var j = 0; j < column_names.length; j++) {
                            const currentColumnName = column_names[j];
                            const rowColumnHeader = document.createElement("th");
                            const rowColumnHeaderText = document.createTextNode(encodeURIComponent(currentColumnName));
                            rowColumnHeader.appendChild(rowColumnHeaderText);
                            rowHeader.appendChild(rowColumnHeader);
                        }
                        const rowColumnHeader = document.createElement("th");
                        const rowColumnHeaderText = document.createTextNode("actions");
                        rowColumnHeader.appendChild(rowColumnHeaderText);
                        rowHeader.appendChild(rowColumnHeader);

                        table.appendChild(rowHeader);
                    }
                }

                {
                    const rowData = document.createElement("tr");
                    for(var j = 0; j < column_names.length; j++) {
                        const currentColumnName = column_names[j];
                        const rowColumnData = document.createElement("td");
                        const rowColumnDataText = document.createTextNode(encodeURIComponent(current_record[currentColumnName]));
                        rowColumnData.appendChild(rowColumnDataText);
                        rowData.appendChild(rowColumnData);
                    }
                    
                    const rowColumnData = document.createElement("td");
                    
                    const viewButton = document.createElement("button");
                    const viewButtonText = document.createTextNode("view");
                    viewButton.appendChild(viewButtonText);
                    rowColumnData.appendChild(viewButton);

                    const editButton = document.createElement("button");
                    const editButtonText = document.createTextNode("edit");
                    editButton.appendChild(editButtonText);
                    rowColumnData.appendChild(editButton);

                    rowData.appendChild(rowColumnData);
                    table.appendChild(rowData);
                }
            }
            main_content.appendChild(table);


            console.log(result);
            load_records(table_name);
        }
        send_http_request(params, callback_function);
    }

    load_table_names = function() {
        var params = {"GetTableNames":{}};
        var callback_function = function(result) {
            var message_type = Object.keys(result)[0]
            if(result[message_type]["[errors]"].length > 0) {
                return;
            }

            leftHandNav = document.getElementById("menu");
            removeAllChildElements(leftHandNav);

            const span = document.createElement("span");
            const length = result[message_type]["data"].length
            for(var i = 0; i < length; i++) {
                var table_name = encodeURIComponent((result[message_type]["data"][i]).replace(/"/g, "\\\""));
                const button = document.createElement("button");
                button.setAttribute("onclick", "navigate_to_view_table(\"" + table_name  + "\")");
                button.setAttribute("class", "button top_menu col-3 col-s-3");
                const text = document.createTextNode(table_name);
                button.appendChild(text);
                span.appendChild(button);
            }
            leftHandNav.appendChild(span);
        }
        send_http_request(params, callback_function);
    }

    document.getElementById("menu_heading").focus();
    load_table_names();


</script>
